#!/bin/bash
# ============================================================================
# Pre-Commit Hook for Aevov
# ============================================================================
# Runs linting and static analysis before allowing commit
# ============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}Running pre-commit checks...${NC}\n"

# Track if any checks fail
CHECKS_FAILED=0

# ============================================================================
# 1. Check for merge conflict markers
# ============================================================================
echo -e "${YELLOW}Checking for merge conflict markers...${NC}"
if git diff --cached --name-only | xargs grep -l -E '<<<<<<< |======= |>>>>>>> ' 2>/dev/null; then
    echo -e "${RED}✗ Merge conflict markers detected!${NC}"
    echo -e "${RED}  Please resolve conflicts before committing${NC}\n"
    exit 1
else
    echo -e "${GREEN}✓ No merge conflict markers${NC}\n"
fi

# ============================================================================
# 2. Check for debugging statements
# ============================================================================
echo -e "${YELLOW}Checking for debugging statements...${NC}"
FORBIDDEN_STATEMENTS=(
    "var_dump("
    "print_r("
    "console.log("
    "dd("
    "dump("
    "debugger;"
)

FOUND_DEBUG=0
for statement in "${FORBIDDEN_STATEMENTS[@]}"; do
    if git diff --cached --name-only | xargs grep -l "$statement" 2>/dev/null; then
        echo -e "${RED}✗ Found debugging statement: $statement${NC}"
        FOUND_DEBUG=1
    fi
done

if [ $FOUND_DEBUG -eq 1 ]; then
    echo -e "${YELLOW}  Warning: Remove debugging statements before committing${NC}"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}✓ No debugging statements found${NC}\n"
fi

# ============================================================================
# 3. PHP Syntax Check
# ============================================================================
echo -e "${YELLOW}Checking PHP syntax...${NC}"

# Get all staged PHP files
PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -n "$PHP_FILES" ]; then
    for file in $PHP_FILES; do
        if [ -f "$file" ]; then
            php -l "$file" > /dev/null 2>&1
            if [ $? -ne 0 ]; then
                echo -e "${RED}✗ PHP syntax error in: $file${NC}"
                php -l "$file"
                CHECKS_FAILED=1
            fi
        fi
    done

    if [ $CHECKS_FAILED -eq 0 ]; then
        echo -e "${GREEN}✓ PHP syntax check passed${NC}\n"
    else
        echo -e "${RED}✗ PHP syntax check failed${NC}\n"
        exit 1
    fi
else
    echo -e "${BLUE}  No PHP files to check${NC}\n"
fi

# ============================================================================
# 4. PHP CodeSniffer
# ============================================================================
echo -e "${YELLOW}Running PHP CodeSniffer...${NC}"

if [ -n "$PHP_FILES" ] && [ -f ".phpcs.xml" ]; then
    if command -v phpcs &> /dev/null; then
        phpcs --standard=.phpcs.xml $PHP_FILES
        if [ $? -ne 0 ]; then
            echo -e "${RED}✗ PHPCS found issues${NC}"
            echo -e "${YELLOW}  Tip: Run 'composer lint:fix' to auto-fix some issues${NC}\n"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ PHPCS check passed${NC}\n"
        fi
    else
        echo -e "${YELLOW}  Warning: phpcs not found, skipping${NC}\n"
    fi
else
    echo -e "${BLUE}  Skipping PHPCS${NC}\n"
fi

# ============================================================================
# 5. PHPStan Static Analysis
# ============================================================================
echo -e "${YELLOW}Running PHPStan...${NC}"

if [ -n "$PHP_FILES" ] && [ -f "phpstan.neon" ]; then
    if command -v phpstan &> /dev/null; then
        # Only analyze changed files
        phpstan analyse --memory-limit=256M --no-progress $PHP_FILES
        if [ $? -ne 0 ]; then
            echo -e "${RED}✗ PHPStan found issues${NC}\n"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ PHPStan check passed${NC}\n"
        fi
    else
        echo -e "${YELLOW}  Warning: phpstan not found, skipping${NC}\n"
    fi
else
    echo -e "${BLUE}  Skipping PHPStan${NC}\n"
fi

# ============================================================================
# 6. JavaScript Linting
# ============================================================================
echo -e "${YELLOW}Running ESLint...${NC}"

# Get all staged JS/JSX files
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$' || true)

if [ -n "$JS_FILES" ]; then
    if command -v eslint &> /dev/null || [ -f "node_modules/.bin/eslint" ]; then
        npm run lint:js -- $JS_FILES
        if [ $? -ne 0 ]; then
            echo -e "${RED}✗ ESLint found issues${NC}"
            echo -e "${YELLOW}  Tip: Run 'npm run lint:js:fix' to auto-fix some issues${NC}\n"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ ESLint check passed${NC}\n"
        fi
    else
        echo -e "${YELLOW}  Warning: eslint not found, skipping${NC}\n"
    fi
else
    echo -e "${BLUE}  No JavaScript files to check${NC}\n"
fi

# ============================================================================
# 7. CSS Linting
# ============================================================================
echo -e "${YELLOW}Running Stylelint...${NC}"

# Get all staged CSS/SCSS files
CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(css|scss)$' || true)

if [ -n "$CSS_FILES" ]; then
    if command -v stylelint &> /dev/null || [ -f "node_modules/.bin/stylelint" ]; then
        npm run lint:css -- $CSS_FILES
        if [ $? -ne 0 ]; then
            echo -e "${RED}✗ Stylelint found issues${NC}"
            echo -e "${YELLOW}  Tip: Run 'npm run lint:css:fix' to auto-fix some issues${NC}\n"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ Stylelint check passed${NC}\n"
        fi
    else
        echo -e "${YELLOW}  Warning: stylelint not found, skipping${NC}\n"
    fi
else
    echo -e "${BLUE}  No CSS files to check${NC}\n"
fi

# ============================================================================
# 8. Check file sizes
# ============================================================================
echo -e "${YELLOW}Checking file sizes...${NC}"

LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | xargs -I {} sh -c '[ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}") -gt 1048576 ] && echo "{}"' || true)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}  Warning: Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}✓ No large files${NC}\n"
fi

# ============================================================================
# Summary
# ============================================================================
if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}════════════════════════════════════════${NC}"
    echo -e "${RED}✗ Pre-commit checks FAILED${NC}"
    echo -e "${RED}════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Fix the issues above and try again${NC}"
    echo -e "${YELLOW}Or use 'git commit --no-verify' to skip checks${NC}\n"
    exit 1
else
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${GREEN}✓ All pre-commit checks PASSED${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}\n"
    exit 0
fi
