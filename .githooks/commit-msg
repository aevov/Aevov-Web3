#!/bin/bash
# ============================================================================
# Commit Message Hook for Aevov
# ============================================================================
# Enforces conventional commit message format
# ============================================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Conventional commit types
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert"

# Regex for conventional commit format
# Format: type(scope): subject
# or: type: subject
COMMIT_REGEX="^($VALID_TYPES)(\([a-z0-9-]+\))?: .{1,100}"

# Check if commit message matches conventional commit format
if ! echo "$COMMIT_MSG" | grep -qE "$COMMIT_REGEX"; then
    echo -e "${RED}════════════════════════════════════════${NC}"
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo -e "${RED}════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Commit message must follow conventional commit format:${NC}"
    echo ""
    echo "  type(scope): subject"
    echo ""
    echo -e "${YELLOW}Valid types:${NC}"
    echo "  feat:     A new feature"
    echo "  fix:      A bug fix"
    echo "  docs:     Documentation changes"
    echo "  style:    Code style changes (formatting, etc.)"
    echo "  refactor: Code refactoring"
    echo "  perf:     Performance improvements"
    echo "  test:     Adding or updating tests"
    echo "  chore:    Build process or tooling changes"
    echo "  ci:       CI/CD changes"
    echo "  build:    Build system changes"
    echo "  revert:   Revert a previous commit"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat(core): add user activation feature"
    echo "  fix(api): resolve authentication issue"
    echo "  docs: update installation instructions"
    echo "  test(workflow): add pattern sync tests"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Tip: Use 'git commit --amend' to fix your message${NC}\n"
    exit 1
fi

# Check subject line length (should be <= 72 characters)
SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -n 1)
SUBJECT_LENGTH=${#SUBJECT_LINE}

if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}════════════════════════════════════════${NC}"
    echo -e "${YELLOW}⚠ Warning: Subject line is too long${NC}"
    echo -e "${YELLOW}════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Subject line should be <= 72 characters${NC}"
    echo "Current length: $SUBJECT_LENGTH"
    echo ""
    echo "Your subject line:"
    echo "  $SUBJECT_LINE"
    echo ""
fi

# Check for imperative mood (should start with verb in base form)
NON_IMPERATIVE_WORDS=(
    "added"
    "adding"
    "updated"
    "updating"
    "fixed"
    "fixing"
    "changed"
    "changing"
    "removed"
    "removing"
)

SUBJECT_AFTER_COLON=$(echo "$SUBJECT_LINE" | sed 's/^[^:]*: //')
FIRST_WORD=$(echo "$SUBJECT_AFTER_COLON" | awk '{print $1}' | tr '[:upper:]' '[:lower:]')

for word in "${NON_IMPERATIVE_WORDS[@]}"; do
    if [ "$FIRST_WORD" = "$word" ]; then
        echo -e "${YELLOW}════════════════════════════════════════${NC}"
        echo -e "${YELLOW}⚠ Warning: Use imperative mood${NC}"
        echo -e "${YELLOW}════════════════════════════════════════${NC}"
        echo ""
        echo -e "${YELLOW}Use base form of verb (add, not added/adding)${NC}"
        echo ""
        echo "Instead of: $word"
        echo "Use: ${word%ing}"  # Simple suggestion
        echo ""
        break
    fi
done

# Success
echo -e "${GREEN}✓ Commit message format is valid${NC}"
exit 0
