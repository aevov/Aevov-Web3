# ============================================================================
# Nginx Site Configuration for Aevov Ecosystem
# ============================================================================
# Additional NGINX configuration for WordPress with Aevov plugins
# Used by serversideup/docker-php FPM+NGINX variant
# ============================================================================

# ----------------------------------------------------------------------------
# Client Request Limits
# ----------------------------------------------------------------------------
client_max_body_size 128M;
client_body_buffer_size 128k;
client_header_buffer_size 4k;
large_client_header_buffers 4 32k;

# ----------------------------------------------------------------------------
# Timeouts
# ----------------------------------------------------------------------------
client_body_timeout 60s;
client_header_timeout 60s;
keepalive_timeout 65s;
send_timeout 60s;
fastcgi_read_timeout 300s;
fastcgi_send_timeout 300s;

# ----------------------------------------------------------------------------
# Gzip Compression
# ----------------------------------------------------------------------------
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml
    font/truetype
    font/opentype
    application/vnd.ms-fontobject;

# ----------------------------------------------------------------------------
# FastCGI Cache Configuration (for WordPress)
# ----------------------------------------------------------------------------
fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header http_500;
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

# ----------------------------------------------------------------------------
# Security Headers
# ----------------------------------------------------------------------------
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# ----------------------------------------------------------------------------
# WordPress Specific Rules
# ----------------------------------------------------------------------------

# Deny access to sensitive files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Deny access to wp-config.php
location ~* wp-config.php {
    deny all;
}

# Deny access to readme files
location ~* ^.*(readme|license|changelog)\.(txt|html)$ {
    deny all;
}

# Allow only specific PHP files in wp-content
location ~* ^/wp-content/.*\.(php)$ {
    deny all;
}

# Optimize static file serving
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf)$ {
    expires 365d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# WordPress REST API - no caching
location ~ ^/wp-json/ {
    fastcgi_cache off;
    fastcgi_no_cache 1;
    fastcgi_cache_bypass 1;
}

# Admin area - no caching
location ~ ^/wp-admin/ {
    fastcgi_cache off;
    fastcgi_no_cache 1;
    fastcgi_cache_bypass 1;
}

# WordPress login - no caching
location ~ ^/wp-login\.php {
    fastcgi_cache off;
    fastcgi_no_cache 1;
    fastcgi_cache_bypass 1;
}

# ----------------------------------------------------------------------------
# Aevov Plugin Specific Rules
# ----------------------------------------------------------------------------

# Aevov Stream - ESI rendering
location ~ ^/aevov-stream/ {
    fastcgi_cache off;
    add_header X-Aevov-Stream "active";
}

# Aevov API endpoints
location ~ ^/wp-json/aevov/ {
    fastcgi_cache off;
    add_header X-Aevov-API "v1";
}

# Pattern sync protocol endpoints
location ~ ^/wp-json/aps/ {
    fastcgi_cache off;
    add_header X-APS-Protocol "v1";
}

# BLOOM pattern recognition
location ~ ^/wp-json/bloom/ {
    fastcgi_cache off;
    add_header X-Bloom-Pattern "active";
}

# ----------------------------------------------------------------------------
# Logging
# ----------------------------------------------------------------------------
access_log /var/log/nginx/access.log combined;
error_log /var/log/nginx/error.log warn;
